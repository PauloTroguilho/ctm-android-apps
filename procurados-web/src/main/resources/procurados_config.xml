<?xml version="1.0" encoding="UTF-8"?>

<config charset="Cp1252">
	<var-def name="baseUrl">
		http://www.portaisgoverno.pe.gov.br
	</var-def>
	<var-def name="listaProcuradosUrl">
		<template>${baseUrl}/web/sds/procurados</template>
	</var-def>
	<!-- iterates over all collected products and extract desired data -->
	<file action="write" path="procurados.xml" charset="UTF-8">
        <![CDATA[ <procurados> ]]>
		<while condition="true" index="pagina" maxloops="2">
			<loop item="procurado" index="i">
				<list>
					<xpath expression="//div[@class='procurados']">
						<html-to-xml>
							<http url="${listaProcuradosUrl}?page=${pagina}" />
						</html-to-xml>
					</xpath>
				</list>
				<body>
					<empty>
						<var-def name="fotoId">
							<xpath expression="substring-after(substring-before(substring-after(//div[@class='imagem']/a/img/@src,'?'),'${sys.escapeXml('&amp;')}'),'=')">
								<var name="procurado" />
							</xpath>
						</var-def>
						<var-def name="detalheUrl">
							<xpath expression="//div[@class='imagem']/a/@href">
								<var name="procurado" />
							</xpath>
						</var-def>
						<var-def name="detalheProcurado">
							<xpath expression="//div[@class='dentro']">
								<html-to-xml>
									<http url="${baseUrl}${detalheUrl}" />
								</html-to-xml>
							</xpath>
						</var-def>
						<var-def name="dados">
							<xpath expression="//div[@class='dados']/*">
								<var name="detalheProcurado" />
							</xpath>
						</var-def>
					</empty>
					<template>
	                    <![CDATA[ 
	                        <procurado>
	                        	<nome>${sys.xpath("data(//div[@class='nome']/h3/a)", procurado.toString())}</nome>
                                <apelido>${sys.xpath("data(//div[@class='nome']/h4/a)", procurado.toString())}</apelido>
                                <fotoId>${fotoId}</fotoId>
                                <historico>${sys.xpath("data(//div[@class='historico']/h3)", detalheProcurado.toString())}</historico>
                        ]]>
                        <loop item="dadoProcurado" index="x">
							<list>
								<var name="dados" />
							</list>
							<body>
								<empty>
									<var-def name="campo" overwrite="true">
										<try>
									        <body>
									            <xpath expression="normalize-space(//h4/strong/text())">
											        <var name="dadoProcurado"/>
											    </xpath>
									        </body>
									        <catch>
									        </catch>
									    </try>
									</var-def>
									<var-def name="valorCampo" overwrite="true">
										<try>
									        <body>
									            <xpath expression="normalize-space(//h5/text())">
											        <var name="dadoProcurado"/>
											    </xpath>
									        </body>
									        <catch>
									        </catch>
									    </try>
									</var-def>
								</empty>
								<case>
									<if condition='${campo.toString().contains("Vulgo")}'>
			                            <![CDATA[ 
				                        	<vulgo>${valorCampo.toString()}</vulgo>
				                        ]]>
			                        </if>
			                        <if condition='${campo.toString().contains("Nº do Processo Judicial")}'>
			                            <![CDATA[ 
				                        	<numeroProcesso>${valorCampo.toString()}</numeroProcesso>
				                        ]]>
			                        </if>
			                        <if condition='${campo.toString().trim().contains("Juíz Competente")}'>
			                            <![CDATA[ 
				                        	<juizCompetente>${valorCampo.toString()}</juizCompetente>
				                        ]]>
			                        </if>
			                    </case>
							</body>     
						</loop>
                        <![CDATA[         
	                        </procurado>
	                    ]]>
	                </template>

				</body>
			</loop>
		</while>
        <![CDATA[ </procurados> ]]>
	</file>
	<!--
	<while condition="true" index="pagina" maxloops="2">
		<loop item="procurado" index="i">
			<list>
				<xpath expression="//div[@class='procurados']">
					<html-to-xml>
						<http url="${listaProcuradosUrl}?page=${pagina}" />
					</html-to-xml>
				</xpath>
			</list>
			<body>
				<var-def name="fotoUrl">
					<xpath expression="//div[@class='imagem']/a/img/@src">
						<var name="procurado" />
					</xpath>
				</var-def>
				<var-def name="fotoId">
					<xquery>
			            <xq-param name="procurado" type="node()">
							<var name="procurado" />
						</xq-param>
			            <xq-expression><![CDATA[
			                  declare variable $procurado as node() external;
			                  let $fotoUrl := data($procurado//div[@class="imagem"]/a/img/@src)
	                          let $fotoId := substring-after(substring-before(substring-after($fotoUrl,"?"),"&amp;"),"=")
			                  return
			                  		$fotoId
			                        ]]>
						</xq-expression>
			        </xquery>
				</var-def>
				<file action="write" path="fotos/proc_${fotoId}.jpeg" type="binary">
					<http url="${sys.fullUrl(listaProcuradosUrl, fotoUrl)}" />
				</file>
			</body>
		</loop>
	</while>
	-->
</config>