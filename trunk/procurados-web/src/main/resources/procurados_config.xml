<?xml version="1.0" encoding="UTF-8"?>

<config charset="Cp1252">
	<var-def name="baseUrl">
		http://www.portaisgoverno.pe.gov.br
	</var-def>
	<var-def name="listaProcuradosUrl">
		<template>${baseUrl}/web/sds/procurados</template>
	</var-def>
	<!-- iterates over all collected products and extract desired data -->
	<file action="write" path="procurados.xml" charset="UTF-8">
        <![CDATA[ <procurados> ]]>
		<while condition="true" index="pagina" maxloops="2">
			<loop item="procurado" index="i">
				<list>
					<xpath expression="//div[@class='procurados']">
						<html-to-xml>
							<http url="${listaProcuradosUrl}?page=${pagina}" />
						</html-to-xml>
					</xpath>
				</list>
				<body>
					<empty>
						<var-def name="detalheUrl">
							<xpath expression="//div[@class='imagem']/a/@href">
								<var name="procurado" />
							</xpath>
						</var-def>
						<var-def name="detalheProcurado">
							<xpath expression="//div[@class='dentro']">
								<html-to-xml>
									<http url="${baseUrl}${detalheUrl}" />
								</html-to-xml>
							</xpath>
						</var-def>
					</empty>
					<xquery>
						<xq-param name="procurado" type="node()">
							<var name="procurado" />
						</xq-param>
						<xq-param name="detalheProcurado" type="node()">
							<var name="detalheProcurado" />
						</xq-param>
						<xq-expression><![CDATA[
	                            declare variable $procurado as node() external;
	                            declare variable $detalheProcurado as node() external;
	                            
	                            let $nome := data($procurado//div[@class="nome"]/h3/a)
	                            let $apelido := data($procurado//div[@class="nome"]/h4/a)
	                            let $fotoUrl := data($procurado//div[@class="imagem"]/a/img/@src)
	                            let $fotoId := substring-after(substring-before(substring-after($fotoUrl,"?"),"&amp;"),"=")
	                            let $hist := data($detalheProcurado//div[@class="historico"]/h3)
	                                return
	                                    <procurado>
	                                        <nome>{$nome}</nome>
	                                        <apelido>{$apelido}</apelido>
	                                        <fotoId>{$fotoId}</fotoId>
	                                        <historico>{$hist}</historico>
	                                    </procurado>
	                    ]]></xq-expression>
					</xquery>
				</body>
			</loop>
		</while>
        <![CDATA[ </procurados> ]]>
	</file>
	<!--
	<while condition="true" index="pagina" maxloops="2">
		<loop item="procurado" index="i">
			<list>
				<xpath expression="//div[@class='procurados']">
					<html-to-xml>
						<http url="${listaProcuradosUrl}?page=${pagina}" />
					</html-to-xml>
				</xpath>
			</list>
			<body>
				<var-def name="fotoUrl">
					<xpath expression="//div[@class='imagem']/a/img/@src">
						<var name="procurado" />
					</xpath>
				</var-def>
				<var-def name="fotoId">
					<xquery>
			            <xq-param name="procurado" type="node()">
							<var name="procurado" />
						</xq-param>
			            <xq-expression><![CDATA[
			                  declare variable $procurado as node() external;
			                  let $fotoUrl := data($procurado//div[@class="imagem"]/a/img/@src)
	                          let $fotoId := substring-after(substring-before(substring-after($fotoUrl,"?"),"&amp;"),"=")
			                  return
			                  		$fotoId
			                        ]]>
						</xq-expression>
			        </xquery>
				</var-def>
				<file action="write" path="fotos/proc_${fotoId}.jpeg" type="binary">
					<http url="${sys.fullUrl(listaProcuradosUrl, fotoUrl)}" />
				</file>
			</body>
		</loop>
	</while>
	-->
</config>